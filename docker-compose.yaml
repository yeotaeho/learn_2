# ============================================================================
# 통합 Docker Compose 설정
# ============================================================================
# Neon PostgreSQL + Upstash Redis 연동
# profiles를 통해 서비스 그룹을 선택적으로 실행할 수 있습니다.
#
# 사용 예시:
#   - 기본 스택 실행 (gateway):
#     docker compose up
#
#   - AI 서비스 포함:
#     docker compose --profile ai up
#
#   - 백그라운드 실행:
#     docker compose up -d
#     docker compose --profile ai up -d
#
# 주의사항:
#   1. Docker Desktop이 실행 중이어야 합니다.
#   2. 루트 디렉토리에 .env 파일 생성 (env.template 참고)
#   3. Neon PostgreSQL과 Upstash Redis 정보를 .env에 설정
# ============================================================================

services:
  # ========================================================================
  # Gateway Service (Spring Boot)
  # ========================================================================
  gateway:
    build:
      context: ./api.labzang.com
      dockerfile: Dockerfile
    container_name: gateway
    ports:
      - "8080:8080"
    networks:
      - labzang-network
    environment:
      - SPRING_PROFILES_ACTIVE=${SPRING_PROFILES_ACTIVE:-default}
      - SPRING_DATASOURCE_URL=${DATABASE_URL}
      - SPRING_DATASOURCE_USERNAME=${DB_USER}
      - SPRING_DATASOURCE_PASSWORD=${DB_PASSWORD}
      - SPRING_JPA_HIBERNATE_DDL_AUTO=${SPRING_JPA_HIBERNATE_DDL_AUTO:-update}
      - SPRING_JPA_SHOW_SQL=${SPRING_JPA_SHOW_SQL:-true}
      - SPRING_REDIS_HOST=${UPSTASH_REDIS_HOST}
      - SPRING_REDIS_PORT=${UPSTASH_REDIS_PORT}
      - SPRING_REDIS_PASSWORD=${UPSTASH_REDIS_PASSWORD}
      - SPRING_REDIS_SSL_ENABLED=true
      - REDIS_HOST=${UPSTASH_REDIS_HOST}
      - REDIS_PORT=${UPSTASH_REDIS_PORT}
      - REDIS_PASSWORD=${UPSTASH_REDIS_PASSWORD}
      - REDIS_URL=${UPSTASH_REDIS_URL}
      - JWT_SECRET=${JWT_SECRET}
    env_file:
      - .env
    restart: on-failure

  # ========================================================================
  # AI Services (FastAPI)
  # ========================================================================
  ai-authservice:
    build:
      context: ./ai.labzang.com
      dockerfile: authservice/Dockerfile
    container_name: ai-authservice
    ports:
      - "9002:9002"
    networks:
      - labzang-network
    environment:
      - DATABASE_URL=${DATABASE_URL}
      - DB_HOST=${DB_HOST}
      - DB_PORT=${DB_PORT}
      - DB_NAME=${DB_NAME}
      - DB_USER=${DB_USER}
      - DB_PASSWORD=${DB_PASSWORD}
      - UPSTASH_REDIS_URL=${UPSTASH_REDIS_URL}
      - UPSTASH_REDIS_HOST=${UPSTASH_REDIS_HOST}
      - UPSTASH_REDIS_PORT=${UPSTASH_REDIS_PORT}
      - UPSTASH_REDIS_PASSWORD=${UPSTASH_REDIS_PASSWORD}
      - REDIS_URL=${UPSTASH_REDIS_URL}
      - REDIS_HOST=${UPSTASH_REDIS_HOST}
      - REDIS_PORT=${UPSTASH_REDIS_PORT}
      - REDIS_PASSWORD=${UPSTASH_REDIS_PASSWORD}
      - REDIS_SSL_ENABLED=true
      - PYTHONUNBUFFERED=1
      - PYTHONDONTWRITEBYTECODE=1
    env_file:
      - .env
    profiles:
      - ai
    restart: on-failure

  crawlerservice:
    build:
      context: ./ai.labzang.com
      dockerfile: crawlerservice/Dockerfile
    container_name: crawlerservice
    ports:
      - "9001:9001"
    networks:
      - labzang-network
    environment:
      - DATABASE_URL=${DATABASE_URL}
      - DB_HOST=${DB_HOST}
      - DB_PORT=${DB_PORT}
      - DB_NAME=${DB_NAME}
      - DB_USER=${DB_USER}
      - DB_PASSWORD=${DB_PASSWORD}
      - UPSTASH_REDIS_URL=${UPSTASH_REDIS_URL}
      - UPSTASH_REDIS_HOST=${UPSTASH_REDIS_HOST}
      - UPSTASH_REDIS_PORT=${UPSTASH_REDIS_PORT}
      - UPSTASH_REDIS_PASSWORD=${UPSTASH_REDIS_PASSWORD}
      - REDIS_URL=${UPSTASH_REDIS_URL}
      - REDIS_HOST=${UPSTASH_REDIS_HOST}
      - REDIS_PORT=${UPSTASH_REDIS_PORT}
      - REDIS_PASSWORD=${UPSTASH_REDIS_PASSWORD}
      - REDIS_SSL_ENABLED=true
      - PYTHONUNBUFFERED=1
      - PYTHONDONTWRITEBYTECODE=1
    env_file:
      - .env
    profiles:
      - ai
    restart: on-failure

  chatbotservice:
    build:
      context: ./ai.labzang.com
      dockerfile: chatbotservice/Dockerfile
    container_name: chatbotservice
    ports:
      - "9003:9003"
    networks:
      - labzang-network
    environment:
      - DATABASE_URL=${DATABASE_URL}
      - DB_HOST=${DB_HOST}
      - DB_PORT=${DB_PORT}
      - DB_NAME=${DB_NAME}
      - DB_USER=${DB_USER}
      - DB_PASSWORD=${DB_PASSWORD}
      - UPSTASH_REDIS_URL=${UPSTASH_REDIS_URL}
      - UPSTASH_REDIS_HOST=${UPSTASH_REDIS_HOST}
      - UPSTASH_REDIS_PORT=${UPSTASH_REDIS_PORT}
      - UPSTASH_REDIS_PASSWORD=${UPSTASH_REDIS_PASSWORD}
      - REDIS_URL=${UPSTASH_REDIS_URL}
      - REDIS_HOST=${UPSTASH_REDIS_HOST}
      - REDIS_PORT=${UPSTASH_REDIS_PORT}
      - REDIS_PASSWORD=${UPSTASH_REDIS_PASSWORD}
      - REDIS_SSL_ENABLED=true
      - PYTHONUNBUFFERED=1
      - PYTHONDONTWRITEBYTECODE=1
    env_file:
      - .env
    profiles:
      - ai
    restart: on-failure

  mlservice:
    build:
      context: ./ai.labzang.com
      dockerfile: mlservice/Dockerfile
    container_name: mlservice
    ports:
      - "9010:9010"
    networks:
      - labzang-network
    volumes:
      - ./ai.labzang.com/mlservice/app/seoul_crime/save:/app/app/seoul_crime/save
      - ./ai.labzang.com/mlservice/app/nlp/save:/app/app/nlp/save
    environment:
      - DATABASE_URL=${DATABASE_URL}
      - DB_HOST=${DB_HOST}
      - DB_PORT=${DB_PORT}
      - DB_NAME=${DB_NAME}
      - DB_USER=${DB_USER}
      - DB_PASSWORD=${DB_PASSWORD}
      - UPSTASH_REDIS_URL=${UPSTASH_REDIS_URL}
      - UPSTASH_REDIS_HOST=${UPSTASH_REDIS_HOST}
      - UPSTASH_REDIS_PORT=${UPSTASH_REDIS_PORT}
      - UPSTASH_REDIS_PASSWORD=${UPSTASH_REDIS_PASSWORD}
      - REDIS_URL=${UPSTASH_REDIS_URL}
      - REDIS_HOST=${UPSTASH_REDIS_HOST}
      - REDIS_PORT=${UPSTASH_REDIS_PORT}
      - REDIS_PASSWORD=${UPSTASH_REDIS_PASSWORD}
      - REDIS_SSL_ENABLED=true
      - PYTHONUNBUFFERED=1
      - PYTHONDONTWRITEBYTECODE=1
    env_file:
      - .env
    profiles:
      - ai
    restart: on-failure

# ========================================================================
# Networks
# ========================================================================
networks:
  labzang-network:
    driver: bridge
    name: labzang-network

# ========================================================================
# 사용법
# ========================================================================
# 1. .env 파일 생성: env.template을 참고하여 .env 파일 생성
# 2. Neon PostgreSQL과 Upstash Redis 정보 입력
# 3. 기본 서비스 실행 (gateway): docker compose up
# 4. AI 서비스 포함: docker compose --profile ai up
# ========================================================================
